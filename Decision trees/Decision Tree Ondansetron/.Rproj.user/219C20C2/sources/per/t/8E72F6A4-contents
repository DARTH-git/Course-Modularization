#########                  Decision Tree  model                 ################
#########             for the CE16 NIHES course                 ################


# Developed by:
# the Decision Analysis in R for Technologies in Health (DARTH) group
# Fernando Alarid-Escudero, PhD (1) 
# Eva A. Enns, MS, PhD (1)	
# M.G. Myriam Hunink, MD, PhD (2,3)
# Hawre J. Jalal, MD, PhD (4) 
# Eline M. Krijkamp, MSc (2)	
# Petros Pechlivanoglou, PhD (5) 

# In collaboration of: 		
# 1 University of Minnesota School of Public Health, Minneapolis, MN, USA
# 2 Erasmus MC, Rotterdam, The Netherlands
# 3 Harvard T.H. Chan School of Public Health, Boston, USA
# 4 University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA
# 5 The Hospital for Sick Children, Toronto and University of Toronto, Toronto ON, Canada

################################################################################
# Please cite our publications when using this code
# darthworkgroup.com
## Jalal H, et al. An Overview of R in Health Decision Sciences. 
# Med. Decis. Making. 2017; 37(3): 735-746. 
## Krijkamp EM, et al. Microsimulation modeling for health decision sciences 
# using R: a tutorial. Med. Decis. Making. 2018; 38(3): 400-422. 

################################################################################
# Copyright 2017, 
# THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS. 
# All rights reserved in Canada, the United States and worldwide.  
# Copyright, trademarks, trade names and any and all associated intellectual 
# property are exclusively owned by THE HOSPITAL FOR SICK CHILDREN and the 
# collaborating institutions and may not be used, reproduced, modified, 
# distributed or adapted in any way without written permission
################################################################################
# Credits for the example: Buxton and O'Brien 1992                        
# Economic evaluation of ondansetron: preliminary analysis using           
# clinical trial data prior to price setting.                              
# Strategies: Ondansetron, Metoclopramide                                   
################################################################################

rm(list = ls())   # clear memory (removes all the variables from the workspace)

####################### INPUT PARAMETERS   #####################################

Strategies   <- c("Metoclopramide", "Ondansetron") # Names of strategies to be studied


#### input values - Ondansetron  ######
  p.semOn            <- 0.25         # Prob. of significant emesis
  p.semAdeOn         <- 0.26         # Prob. of ADE after emesis
  p.semAdeTrtOn      <- 0.60         # Prob. of treatment after ADE with emesis
  p.semAdeTrtResOn   <- 0.66         # Prob. of resolution of treated ADE with emesis
  p.semAdeNotrtResOn <- 1            # Prob. of resolution after ADE that did not require treament
      
  p.nosemAdeOn         <- 0.11        # Prob. of ADE without emesis
  p.nosemAdeTrtOn      <- 0.17        # Prob. of treatment after ADE without  emesis
  p.nosemAdeTrtResOn   <- 1           # Prob. of resolution of treated ADE without emesis
  p.nosemAdeNotrtResOn <- 1           # Prob. of resolution of non treated ADE without emesis
  
  c.trtOn               <- 10         # cost of treatment
  c.semOn               <- 30         # cost of episode of emesis
  c.adeOn               <- 20         # cost of ADE
  c.adeTrtOn            <-  5         # cost of treating an ADE


#### input values - Metoclopramide  ######
  p.semMet            <- 0.58      # Prob. of significant emesis
  p.semAdeMet         <- 0.34      # Prob. of ADE after emesis
  p.semAdeTrtMet      <- 0.60      # Prob. of treatment after ADE with emesis
  p.semAdeTrtResMet   <- 0.78      # Prob. of resolution of treated ADE with emesis
  p.semAdeNotrtResMet <- 1         # Prob. of resolution after ADE that did not require treament
   <-
  p.nosemAdeMet         <- 0.12    # Prob. of ADE without emesis
  p.nosemAdeTrtMet      <- 0.50    # Prob. of treatment after ADE without  emesis
  p.nosemAdeTrtResMet   <- 1       # Prob. of resolution of treated ADE without emesis
  p.nosemAdeNotrtResMet <- 1       # Prob. of resolution of non treated ADE without emesis 

  c.trtMet               <- 10     # cost of treatment
  c.semMet               <- 30     # cost of episode of emesis
  c.adeMet               <- 20     # cost of ADE
  c.adeTrtMet            <-  5     # cost of treating an ADE


         


####################  DECISION TREE ESTIMATION ########################################

v.w.On <-c(   p.semOn *   (1 - p.semAdeOn),                                                     #  emesis with no ADEs
              p.semOn *        p.semAdeOn   *      p.semAdeTrtOn    *      p.semAdeTrtResOn,    # ADE after emesis that was treated and resolved
              p.semOn *        p.semAdeOn   *      p.semAdeTrtOn    * (1 - p.semAdeTrtResOn),   # ADE after emesis that was treated and did not resolve
              p.semOn *        p.semAdeOn   * (1 - p.semAdeTrtOn)   *      p.semAdeNotrtResOn,  # ADE after emesis that was not treated and resolved
              p.semOn *        p.semAdeOn   * (1 - p.semAdeTrtOn)   * (1 - p.semAdeNotrtResOn), # ADE after emesis that was not treated and did not resolve
        (1 - p.semOn) * (1 - p.nosemAdeOn),                                                     # no emesis with no ADEs
        (1 - p.semOn) *      p.nosemAdeOn *      p.nosemAdeTrtOn  *      p.nosemAdeTrtResOn,    # ADE after no emesis that was treated and resolved
        (1 - p.semOn) *      p.nosemAdeOn *      p.nosemAdeTrtOn  * (1 - p.nosemAdeTrtResOn),   # ADE after no emesis that was treated and did not resolve
        (1 - p.semOn) *      p.nosemAdeOn * (1 - p.nosemAdeTrtOn) *      p.nosemAdeNotrtResOn,  # ADE after no emesis that was not treated and resolved
        (1 - p.semOn) *      p.nosemAdeOn * (1 - p.nosemAdeTrtOn) * (1 - p.nosemAdeNotrtResOn)) # ADE after no emesis that was not treated and did not resolve
      
v.w.Met <-c(p.semMet *   (1 - p.semAdeMet),                                                       #  emesis with no ADEs
            p.semMet *        p.semAdeMet   *      p.semAdeTrtMet    *      p.semAdeTrtResMet,    # ADE after emesis that was treated and resolved
            p.semMet *        p.semAdeMet   *      p.semAdeTrtMet    * (1 - p.semAdeTrtResMet),   # ADE after emesis that was treated and did not resolve
            p.semMet *        p.semAdeMet   * (1 - p.semAdeTrtMet)   *      p.semAdeNotrtResMet,  # ADE after emesis that was not treated and resolved
            p.semMet *        p.semAdeMet   * (1 - p.semAdeTrtMet)   * (1 - p.semAdeNotrtResMet), # ADE after emesis that was not treated and did not resolve
            (1 - p.semMet) * (1 - p.nosemAdeMet),                                                     # no emesis with no ADEs
            (1 - p.semMet) *      p.nosemAdeMet *      p.nosemAdeTrtMet  *      p.nosemAdeTrtResMet,  # ADE after no emesis that was treated and resolved
            (1 - p.semMet) *      p.nosemAdeMet *      p.nosemAdeTrtMet  * (1 - p.nosemAdeTrtResMet), # ADE after no emesis that was treated and did not resolve
            (1 - p.semMet) *      p.nosemAdeMet * (1 - p.nosemAdeTrtMet) *      p.nosemAdeNotrtResMet,  # ADE after no emesis that was not treated and resolved
            (1 - p.semMet) *      p.nosemAdeMet * (1 - p.nosemAdeTrtMet) * (1 - p.nosemAdeNotrtResMet)) # ADE after no emesis that was not treated and did not resolve


v.c.On <-                                           # Estimating cost per path for the ondasentron arm
  c(c.trtOn + c.semOn,
    c.trtOn + c.semOn + c.adeOn + c.adeTrtOn,
    c.trtOn + c.semOn + c.adeOn + c.adeTrtOn, 
    c.trtOn + c.semOn + c.adeOn,
    c.trtOn + c.semOn + c.adeOn,
    c.trtOn,
    c.trtOn + c.adeOn + c.adeTrtOn,
    c.trtOn + c.adeOn + c.adeTrtOn, 
    c.trtOn + c.adeOn,
    c.trtOn + c.adeOn)  

v.c.Met <-                                          # Estimating cost per path for the metoclopramide arm
  c(c.trtMet + c.semMet,
    c.trtMet + c.semMet + c.adeMet + c.adeTrtMet,
    c.trtMet + c.semMet + c.adeMet + c.adeTrtMet, 
    c.trtMet + c.semMet + c.adeMet,
    c.trtMet + c.semMet + c.adeMet,
    c.trtMet,
    c.trtMet + c.adeMet + c.adeTrtMet,
    c.trtMet + c.adeMet + c.adeTrtMet, 
    c.trtMet + c.adeMet,
    c.trtMet + c.adeMet)  


v.e.On <- v.e.Met <-  c(0,  # vector of health outcomes for both therapies for each path
                        0,
                        0,
                        0, 
                        0, 
                        1,
                        0,
                        0, 
                        0,
                        0) 

 ##################OUTPUT #######################

ev.c.On  <- sum(v.w.On * v.c.On)    # expected   costs - Ondansetron
ev.e.On  <- sum(v.w.On * v.e.On)    # expected effects - Ondansetron

ev.c.Met  <- sum(v.w.Met * v.c.Met)    # expected   costs - Ondansetron
ev.e.Met  <- sum(v.w.Met * v.e.Met)    # expected effects - Ondansetron


delta.c  <- ev.c.On - ev.c.Met   # incremental costs
delta.e  <- ev.e.On - ev.e.Met   # incremental effectiveness
icer     <- delta.c / delta.e    # incremental cost-effectiveness ratio

table.res <- matrix(c(ev.c.Met, ev.e.Met, NA, NA, NA,
                      ev.c.On, ev.e.On, delta.c, delta.e, icer ),
                    nrow = 2, byrow = T,
                    dimnames = list(Strategies, c("Cost", "Effectiveness", "Incremental Costs", "Incremental Effects", "ICER")))
table.res <- as.data.frame(table.res)
table.res <- round( table.res, 3)
table.res$ICER[table.res$"Incremental Costs" < 0 & 
               table.res$"Incremental Effects" > 0] ="Dominant"


table.res

