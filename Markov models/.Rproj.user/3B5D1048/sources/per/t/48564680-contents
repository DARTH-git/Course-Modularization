#####################################################################################
##################          Markov Sick-Sicker model in R          ##################
#####################################################################################

# Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup
# Fernando Alarid-Escudero, PhD (1)
# Eva A. Enns, MS, PhD (2)
# M.G. Myriam Hunink, MD, PhD (3,4)
# Hawre J. Jalal, MD, PhD (5)
# Eline M. Krijkamp, MSc (3)
# Petros Pechlivanoglou, PhD (6)

# In collaboration of:
# 1 Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT,
#   Aguascalientes, Mexico
# 2 University of Minnesota School of Public Health, Minneapolis, MN, USA
# 3 Erasmus MC, Rotterdam, The Netherlands
# 4 Harvard T.H. Chan School of Public Health, Boston, USA
# 5 University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA
# 6 The Hospital for Sick Children, Toronto and University of Toronto, Toronto ON, Canada

#####################################################################################
# Please cite our publications when using this code
# - Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG.
# An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746.
# https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559

#####################################################################################
# Copyright 2017, THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS.
# All rights reserved in Canada, the United States and worldwide. Copyright,
# trademarks, trade names and any and all associated intellectual property are
# exclusively owned by THE HOSPITAL FOR Sick CHILDREN and the collaborating
# institutions. These materials may be used, reproduced, modified, distributed
# and adapted with proper attribution.
#####################################################################################


# rm(list = ls())   # clear memory (removes all the variables from the workspace)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) # set working directory

#### 00 Install and load packages ####
### Uncomment if you don't have all required packages installed
# source("app0_packages_setup.R", echo = TRUE)


#### 01 Load packages ####
# library(ggplot2)
# library(dampack)
# library(dplyr)
# library(scales)
# library(ellipse)
# library(truncnorm)
# library(reshape2)


#### 02 Load Functions ####
# source("Functions.R")


#### 03 Input Model Parameters ####
### Strategy names
v_names_str <- c("No Treatment", "Treatment")
### Number of strategies
n_str   <- length(v_names_str)
### Markov model parameters
age     <- 25                       # age at baseline
max_age <- 55                       # maximum age of follow up
n_t     <- max_age - age            # time horizon, number of cycles
v_n     <- c("H", "S1", "S2", "D")  # the 4 states of the model: Healthy (H), Sick (S1), Sicker (S2), Dead (D)
n_s     <- length(v_n)              # number of health states

# Transition probabilities (per cycle)
p_HD    <- 0.005                    # probability to die when healthy
p_HS1   <- 0.15          	          # probability to become sick when healthy
p_S1H   <- 0.5           	          # probability to become healthy when sick
p_S1S2  <- 0.105         	          # probability to become sicker when sick
hr_S1   <- 3             	          # hazard ratio of death in sick vs healthy
hr_S2   <- 10            	          # hazard ratio of death in sicker vs healthy
r_HD    <- - log(1 - p_HD)          # rate of death in healthy
r_S1D   <- hr_S1 * r_HD  	          # rate of death in sick
r_S2D   <- hr_S2 * r_HD  	          # rate of death in sicker
p_S1D   <- 1 - exp(-r_S1D)          # probability to die in sick
p_S2D   <- 1 - exp(-r_S2D)          # probability to die in sicker

# Cost and utility inputs
c_H     <- 2000                     # cost of remaining one cycle in the healthy state
c_S1    <- 4000                     # cost of remaining one cycle in the sick state
c_S2    <- 15000                    # cost of remaining one cycle in the sicker state
c_trt   <- 12000                    # cost of treatment(per cycle)
c_D     <- 0                        # cost of being in the death state
u_H     <- 1                        # utility when healthy
u_S1    <- 0.75                     # utility when sick
u_S2    <- 0.5                      # utility when sicker
u_D     <- 0                        # utility when dead
u_trt   <- 0.95                     # utility when being treated

# Discounting factor
d_r <- 0.03                         # equal discount of costs and QALYs by 3%
v_dwc <- 1 / (1 + d_r) ^ (0:n_t)    # calculate discount weights for costs for each cycle based on discount rate d_r
v_dwe <- 1 / (1 + d_r) ^ (0:n_t)    # calculate discount weights for effectiveness for each cycle based on discount rate d_r


#### 04 Define and initialize matrices and vectors ####
#### 04.1 Cohort trace ####
### create the markov trace matrix M capturing the proportion of the cohort in each state at each cycle
m_M_no_trt <- m_M_trt <- matrix(NA,
                                nrow     = n_t + 1, ncol = n_s,
                                dimnames = list(paste("cycle", 0:n_t, sep = " "), v_n))

head(m_M_no_trt) # show first 6 rows of the matrix

### The cohort starts as healthy
m_M_no_trt[1, ] <- m_M_trt[1, ] <- c(1, 0, 0, 0) # initiate first cycle of cohort trace

#### 04.2 Transition probability matrix ####
# create the transition probability matrix for NO treatment
m_P_notrt  <- matrix(0,
                     nrow = n_s,
                     ncol = n_s,
                     dimnames = list(v_n, v_n)) # name the columns and rows of the transition probability matrix
m_P_notrt

### fill in the transition probability array
# From Healthy

# From Sick

# From Sicker

# From Dead

### create transition probability matrix for treatment same as no treatment
m_P_trt <- m_P_notrt

#### 05 Run Markov model ####


#### 06 Compute and Plot Epidemiological Outcomes ####
#### 06.1 Cohort trace #####

#### 06.2 Overall Survival (OS) #####

#### 06.2.1 Life Expectancy (LE) #####

#### 06.3 Disease prevalence #####

#### 06.4 Proportion of sick in S1 state #####


#### 07 Compute Cost-Effectiveness Outcomes ####

#### 07.1 Mean Costs and QALYs for Treatment and NO Treatment ####

#### 07.2 Discounted Mean Costs and QALYs ####

#### 07.3 Compute ICERs of the Markov model ####

#### 07.4 Plot frontier of the Markov model ####
