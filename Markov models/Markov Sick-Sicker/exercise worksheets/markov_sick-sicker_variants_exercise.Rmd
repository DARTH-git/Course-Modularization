---
title: "Decision Modeling for Public Health"
subtitle: 'Markov Model Variants Exercise'
author: "The DARTH workgroup"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:

Fernando Alarid-Escudero, PhD (1) 

Eva A. Enns, MS, PhD (2)	

M.G. Myriam Hunink, MD, PhD (3,4)

Hawre J. Jalal, MD, PhD (5) 

Eline M. Krijkamp, MSc (3)	

Petros Pechlivanoglou, PhD (6,7)

Alan Yang, MSc (7)

In collaboration of: 		

1. Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT, 
   Aguascalientes, Mexico
2. University of Minnesota School of Public Health, Minneapolis, MN, USA
3. Erasmus MC, Rotterdam, The Netherlands
4. Harvard T.H. Chan School of Public Health, Boston, USA
5. University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA
6. University of Toronto, Toronto ON, Canada
7. The Hospital for Sick Children, Toronto ON, Canada

Please cite our publications when using this code:
 
- Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG. 
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746. 
https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559
 
- Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P. 
Microsimulation modeling for health decision sciences using R: A tutorial. 
Med Decis Making. 2018;38(3):400â€“22. 
https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513
 
- Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H. 
A Multidimensional Array Representation of State-Transition Model Dynamics. 
Med Decis Making. 2020 Online first. https://doi.org/10.1177/0272989X19893973

Copyright 2017, THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS. 
All rights reserved in Canada, the United States and worldwide. Copyright, 
trademarks, trade names and any and all associated intellectual property are 
exclusively owned by THE HOSPITAL FOR Sick CHILDREN and the collaborating 
institutions. These materials may be used, reproduced, modified, distributed 
and adapted with proper attribution.

# Exercise I: Variations on the Sick-Sicker Markov Model

Previously, you built a Markov of the Sick-Sicker model where transition probabilities were assumed to be constant over time. In this exercise, you will expand on that model to incorporate dependence on time since model start and on state residence.

**Time since model start**

Healthy individuals are no longer assumed to have a fixed mortality rate. Their mortality rate depends on their age. The Human Mortality Database (HMD) (www.mortality.org) provides these age specific mortality rates (Mx1x1). You can load this data in R using different packages, for example the HMDHFplus, demography or data.table package. Registration (free) on the HMD website is required in order to use the data. For this exercise, we provide you with this mortality rate for the US in the file `HMD_USA_Mx_2015.csv`.

Remember: individuals in S1 and S2 still have an increased mortality relative to healthy individuals, as described in the original exercise. The same hazard ratios are used to calculate the probabilities of dying from S1 and S2 in this exercise. 

**State residence**

It has been recently discovered that the risk of progression from Sick to Sicker increases the longer a person has been sick. This increase follows a Weibull growth curve, calculated as 

$p_{S1S2(t)} = \lambda_\gamma t^{(\gamma-1)}$

where $t$ is the $t$-th cycle (year) that a person has been in the Sick state. $\lambda = 0.08$ and $\gamma = 1.1$ are the scale and shape parameters of the Weibull function, respectively.

We will now expand the model to include age and state residence dependency by adding age varying probabilities for death and tunnel states for S1, as shown in Figure 2.

```{r, echo = FALSE, warning = FALSE, message = FALSE, out.width = '100%', fig.cap='Schematic representation of the Sick-Sicker model', fig.align = 'center'}
if (!require(here)) install.packages('here')
if (!require(knitr)) install.packages('knitr')
include_graphics(here::here("figures", "sick_sicker_diagram.png"))
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, out.width = '100%', fig.cap = 'Schematic representation of the Sick-Sicker model with tunnels states for S1', fig.align = 'center'}
if (!require(here)) install.packages('knitr')
if (!require(knitr)) install.packages('knitr')
include_graphics(here::here("figures", "sick_sicker_tunnels_diagram.png"))
```

## Tasks

Using the template `markov_sick-sicker_variants_template.Rmd`, please do the following:

1. Incorporate the tunnel states in the Markov trace and initialize it with everyone being healthy at model start. 

2. Create a 3D transition probability array to account for tunnels and age dependency.

3. Fill in the 3D transition probability array accounting for the tunnel states for S1 and the age dependence of transitioning to death

4. Costs and utilities for all tunnel states are the same. Therefre, aggregate the Markov trace back to a healthy sick-sicker-dead trace and estimate total costs and QALYs for both strategies.

5. Estimate incremental costs and QALYs and the ICER.  

6. Plot the survival curve for the cohort under no treatment. 

|           **Parameter**            |  **R name** |   **Value**   |
|:-----------------------------------|:------------|:-------------:|
| Time horizon                       | `n_t`       | 30 years      |
| Cycle length                       |             | 1 year        |
| Names of health states             | `v_n`       | H, S1, S2, D  |
| Annual discount rate (costs/QALYs) | `d_c` `d_e` |  3%           |
| Annual transition probabilities    |             |               |
| - Disease onset (H to S1), conditional on surviving          | `p_HS1`     |  0.15         |
| - Recovery (S1 to H), conditional on survival               | `p_S1H`     |  0.5          |
| - Disease progression (S1 to S2), conditional on surviving   | `p_S1S2`    | Weibull function |
| Annual mortality                   |             |               |
| - All-cause mortality (H to D)     | `p_HD`      | Age-dependent |
| - Hazard ratio of death in S1 vs H | `hr_S1`     |  3            |
| - Hazard ratio of death in S2 vs H | `hr_S2`     |  10           |
| Annual costs                       |             |               |
| - Healthy individuals              | `c_H`       |  $2,000       |
| - Sick individuals in S1           | `c_S1`      |  $4,000       |
| - Sick individuals in S2           | `c_S2`      |  $15,000      |
| - Dead individuals                 | `c_D`       |  $0           |
| - Additional costs of sick individuals treated in S1 or S2       | `c_trt` | $12,000 |
| Utility weights                    |             |               |
| - Healthy individuals              | `u_H`       |  1.00         |
| - Sick individuals in S1           | `u_S1`      |  0.75         |
| - Sick individuals in S2           | `u_S2`      |  0.50         |
| - Dead individuals                 | `u_D`       |  0.00         |
| Intervention effect                |             |               |
| - Utility for treated individuals in S1 | `u_trt` |  0.95        |

*Note: To calculate the probability of dying from S1 and S2, use the hazard ratios provided. To do so, first convert the probability of dying from healthy, `p_HD`, to a rate; then multiply this rate by the appropriate hazard ratio; finally, convert this rate back to a probability. Recall that you can convert between rates and probabilities using the following formulas: $r = -log(1-p)$ and $p = 1-e^{(-rt)}$

