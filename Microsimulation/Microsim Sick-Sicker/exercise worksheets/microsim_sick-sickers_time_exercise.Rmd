---
title: "Cost-Effectiveness and Decision Modeling in R"
author: "The DARTH workgroup"
subtitle: Exercises – Microsimulation models with time-in-state dependence 
output:
  pdf_document: default
  word_document: default
  html_document: default
---

Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:

Fernando Alarid-Escudero, PhD (1) 

Eva A. Enns, MS, PhD (2)	

M.G. Myriam Hunink, MD, PhD (3,4)

Hawre J. Jalal, MD, PhD (5) 

Eline M. Krijkamp, MSc (3)	

Petros Pechlivanoglou, PhD (6)

Alan Yang, MSc (7)

In collaboration of: 		

1. Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT, 
   Aguascalientes, Mexico
2. University of Minnesota School of Public Health, Minneapolis, MN, USA
3. Erasmus MC, Rotterdam, The Netherlands
4. Harvard T.H. Chan School of Public Health, Boston, USA
5. University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA
6. The Hospital for Sick Children, Toronto and University of Toronto, Toronto ON, Canada
7. The Hospital for Sick Children, Toronto ON, Canada

Please cite our publications when using this code:
 
- Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG. 
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746. 
https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559
 
- Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P. 
Microsimulation modeling for health decision sciences using R: A tutorial. 
Med Decis Making. 2018;38(3):400–22. 
https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513
 
- Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H. 
A Multidimensional Array Representation of State-Transition Model Dynamics. 
BioRxiv 670612 2019.https://www.biorxiv.org/content/10.1101/670612v1

Copyright 2017, THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS. 
All rights reserved in Canada, the United States and worldwide. Copyright, 
trademarks, trade names and any and all associated intellectual property are 
exclusively owned by THE HOSPITAL FOR Sick CHILDREN and the collaborating 
institutions. These materials may be used, reproduced, modified, distributed 
and adapted with proper attribution.

# Exercise: A Microsimulation model – The Sick-Sicker model

In this exercise, we will model the hypothetical Sick-Sicker disease using a microsimulation model. The Sick-Sicker disease has been previously modeled as a Markov model using four health states (Figure 1): Healthy (H); two disease states, Sick (S1) and Sicker (S2); and Dead (D). 

Two of the advantages of using a microsimulation implementation, which are to incorporate i) ‘memory’ into the disease dynamics and ii) variation in the baseline characteristics for every individual. To illustrate this, we extend the Sick-Sicker microsimulation model to include memory effects and patient heterogeneity at baseline. Specifically, we assume that the individual mortality rate increases the longer a patient spends in one of the sick states and that effectiveness of treatment is dependent on the duration of stay in the sick states and on baseline characteristics. Healthy individuals still have a death rate based on the Human Mortality Database. 

Three modifications were made to the model:

i)	The mortality rates depend on age

ii)	The mortality rates in the sick/sicker states depend on the duration of remaining in the disease states (see Table 1). 

iii) The improvement on quality of life by the treatment varies across individuals through a characteristic that acts as a treatment effect modifier. All model parameter values and R variable names are presented in Table 1.

After you have successfully implemented the natural history of the Sick-Sicker disease as a microsimulation, you can expand the model to include the possibility of treatment and evaluate whether it is cost-effective given a willingness to pay of $20,000. This hypothetical treatment improves the quality of life for those in the Sick state; however, it is not possible to distinguish between individuals in the Sick state from those in the Sicker state, so under a treatment strategy, individuals in both sick states must be treated (and incur the costs of treatment). Treatment parameters are also summarized in the table below.

## Tasks

There are quite some steps you need to take in order to create a microsimulation reflecting this case.

1. Open the Microsimulation student template to load the data for the time dependency and the individual characteristics. This templates makes use the files called `mortProb.csv` and `MyPopulation-AgeDistribtion.csv`. Start adjusting the `Probs()`, `Costs()` and `Eff()` functions to incorporate the new case.

2. Simulate a population of 100,000 individuals and plot the resulting distributions of remaining lifetime costs and QALYs.

3. Expand your microsimulation to include the possibility of the hypothetical treatment for the Sick-Sicker disease (and its impact on costs and quality of life). Create a new variable that can be used to turn treatment on and off in the model.

4. Simulate a population of 100,000 individuals under a treatment strategy where anyone who is sick (in the Sick or Sicker states) receives treatment. Plot the resulting distributions of remaining lifetime costs and QALYs.

5. Calculate the incremental cost-effectiveness ratio of treatment compared to no treatment. 

**Table 1: Input parameters for the time dependent Sick-Sicker Microsimulation **

|           **Parameter**            |  **R name** |   **Value**   |
|:-----------------------------------|:------------|:-------------:|
| Time horizon                       | `n_t`       | 30 years      |
| Cycle length                       |             | 1 year        |
| Names of simulated individuals     | `n_i`       | 1000          |
| Names of health states             | `v_n`       | H, S1, S2, D  |
| Annual discount rate (costs/QALYs) | `d_r`       |  3%           |
| Population characteristics         |             |               |
| - Agedistribution                  |  --         | Range:25-55 distributed as in `MyPopulation-AgeDistribution.csv`|
| Annual transition probabilities    |             |               |
| - Disease onset (H to S1)          | `p_HS1`     |  0.15         |
| - Recovery (S1 to H)               | `p_S1H`     |  0.5          |
| - Disease progression (S1 to S2)   | `p_S1S2`    |  0.105        |
| Annual mortality                   |             |               |
| - All-cause mortality (H to D)     | `p_HD`      | Human Mortality Database: age dependent from 2015|
| - Probability of death is S1 (S1 to D) | `p_S1D` |               |
| Cycle 1                            |             |  0.0149       |
| Cycle 2                            |             |  0.018        |
| Cycle 3                            |             |  0.021        |
| Cycle 4                            |             |  0.026        |
| Cycle 5                            |             |  0.031        |
| Cycle 6 and on                     |             |  0.037        |
| - Probability of death in S2 (S2 to D) | `p_S2D` |  0.048        |
| Annual costs                       |             |               |
| - Healthy individuals              | `c_H`       |  $2,000       |
| - Sick individuals in S1           | `c_S1`      |  $4,000       |
| - Sick individuals in S2           | `c_S2`      |  $15,000      |
| - Dead individuals                 | `c_D`       |  $0           |
| - Additional costs of sick individuals treated in S1 or S2       | `c_trt` | $12,000 |
| Utility weights                    |             |               |
| - Healthy individuals              | `u_H`       |  1.00         |
| - Sick individuals in S1           | `u_S1`      |  0.75         |
| - Sick individuals in S2           | `u_S2`      |  0.50         |
| - Dead individuals                 | `u_D`       |  0.00         |
| Intervention effect                |             |               |
| - Utility for treated individuals in S1 | `u_trt` |  0.95        |
| Time varying extension of Sick-Sicker model |     |              |
| - Treatment effect modifier at baseline     | `v_x` | Uniform(0.95, 1.05) |

```{r, echo=F, warning=F, message=F, out.width='100%', fig.cap='Schematic representation of the Sick-Sicker model', fig.align='center'}
if (!require(here)) install.packages('here')
if (!require(knitr)) install.packages('knitr')
knitr::include_graphics(here::here("figures", "sick_sicker_diagram.png"))
```

