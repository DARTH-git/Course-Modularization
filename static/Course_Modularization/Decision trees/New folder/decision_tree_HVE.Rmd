---
title: "Three-strategy decision tree in R - HVE"
author: "The DARTH workgroup"
output:
  pdf_document: default
  word_document: default
  html_document: default
self_contained: no
keep_tex: yes
---

Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:

Fernando Alarid-Escudero, PhD (1) 
Eva A. Enns, MS, PhD (2)
M.G. Myriam Hunink, MD, PhD (3,4)
Hawre J. Jalal, MD, PhD (5) 
Eline M. Krijkamp, MSc (3)	
Petros Pechlivanoglou, PhD (6, 7)
Alan Yang, MSc (7)

In collaboration of: 		

1. Stanford University, Stanford, CA, USA
2. University of Minnesota School of Public Health, Minneapolis, MN, USA
3. Erasmus MC, Rotterdam, The Netherlands
4. Harvard T.H. Chan School of Public Health, Boston, USA
5. University of Ottawa, Ottawa, ON, Canada
6. University of Toronto, Toronto ON, Canada
7. The Hospital for Sick Children, Toronto ON, Canada

Please cite relevant publications when using this code:

- Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG. 
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3). 
https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559

- Alarid-Escudero, F., Krijkamp, E.M., Pechlivanoglou, P. et al. A Need for Change! 
A Coding Framework for Improving Transparency in Decision Modeling. 
PharmacoEconomics 2019; 37. https://doi.org/10.1007/s40273-019-00837-x

- Alarid-Escudero F, Krijkamp EM, Enns EA, Yang A, Hunink MGM Pechlivanoglou P,
Jalal H. An Introductory Tutorial on Cohort State-Transition Models in R Using a 
Cost-Effectiveness Analysis Example. Medical Decision Making, 2023; 43(1).
(Epub). https://doi.org/10.1177/0272989X221103163

- Alarid-Escudero F, Krijkamp EM, Enns EA, Yang A, Hunink MGM Pechlivanoglou P,
Jalal H. A Tutorial on Time-Dependent Cohort State-Transition Models in R using 
a Cost-Effectiveness Analysis Example. Medical Decision Making, 2023; 43(1). 
https://doi.org/10.1177/0272989X221121747

- Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P. 
Microsimulation modeling for health decision sciences using R: A tutorial. 
Medical Decision Making. 2018; 38(3). 
https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513
 
- Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H. 
A Multidimensional Array Representation of State-Transition Model Dynamics. 
Medical Decision Making. 2020; 40(2). https://doi.org/10.1177/0272989X19893973

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = TRUE)
```

Change `eval` to `TRUE` if you want to knit this document.

```{r}
rm(list = ls())      # clear memory (removes all the variables from the workspace)
```

# 01 Load packages

```{r, warning = FALSE, message = FALSE}

# use this package to conveniently install other packages
if (!require('pacman')) install.packages('pacman'); library(pacman) 

# load (install if required) packages from CRAN
p_load("dampack")  

```

# 02 Load functions

```{r}
# all functions are in the darthtools package
```

# 03 Define parameter input values

```{r}
v_names_str    <- c('Do not treat', "Treat", "Biopsy")  # names of strategies
n_str          <- length(v_names_str)                   # number of strategies
wtp            <- 100000                          # willingness to pay threshold

# Probabilities
p_HVE          <- 0.52   # prevalence of HVE
p_HVE_comp     <- 0.71   # complications with untreated HVE
p_OVE_comp     <- 0.01   # complications with untreated OVE
p_HVE_comp_tx  <- 0.36   # complications with treated HVE
p_OVE_comp_tx  <- 0.20   # complications with treated OVE
p_biopsy_death <- 0.005  # probability of death due to biopsy

# QALYs
q_VE           <- 20     # remaining QALYs for those without VE-related complications
q_VE_comp      <- 19     # remaining QALYs for those with VE-related complications
q_death_biopsy <- 0      # remaining QALYs for those who died during biopsy
q_loss_biopsy  <- 0.01   # one-time QALY loss due to brain biopsy


# Costs
c_VE               <- 1200   # cost of viral encephalitis care without complications
c_VE_comp          <- 9000   # cost of viral encephalitis care with complications
c_tx               <- 9500   # cost of treatment
c_biopsy           <- 25000  # cost of brain biopsy
c_lifetime         <- 50000  # expected remaining lifetime costs without complications
c_lifetime_comp    <- 60000  # expected remaining lifetime costs with complications

```

# 04 Create and run decision tree model

```{r}
# For each strategy, define vector of path probabilities for each path 

# No treatment
v_prob_notx  <- c(    p_HVE  *      p_HVE_comp  ,  # HVE, complications
                      p_HVE  * (1 - p_HVE_comp) ,  # HVE, no complications
                 (1 - p_HVE) *      p_OVE_comp  ,  # OVE, complications
                 (1 - p_HVE) * (1 - p_OVE_comp))   # OVE, no complications

# Treat all
v_prob_tx  <- c(      p_HVE  *      p_HVE_comp_tx  ,  # HVE, complications
                      p_HVE  * (1 - p_HVE_comp_tx) ,  # HVE, no complications
                 (1 - p_HVE) *      p_OVE_comp_tx  ,  # OVE, complications
                 (1 - p_HVE) * (1 - p_OVE_comp_tx))   # OVE, no complications
  
# Biopsy
v_prob_biopsy  <- c((1-p_biopsy_death) * p_HVE       * p_HVE_comp_tx      ,  # survive, HVE, complications
                    (1-p_biopsy_death) * p_HVE       * (1 - p_HVE_comp_tx),  # survive, HVE, no complications
                    (1-p_biopsy_death) * (1 - p_HVE) *      p_OVE_comp ,  # survive, OVE, complications
                    (1-p_biopsy_death) * (1 - p_HVE) * (1 - p_OVE_comp),  # survive, OVE, no complications
                    p_biopsy_death)                                       # die from biopsy
  
# For each strategy, create vector of terminal node values at each path terminus 
## QALYs
v_qaly_notx  <- c(q_VE_comp,  # HVE, complications
                  q_VE     ,  # HVE, no complications
                  q_VE_comp,  # OVE, complications
                  q_VE)       # OVE, no complications
  
v_qaly_tx    <- c(q_VE_comp,  # HVE, complications
                  q_VE     ,  # HVE, no complications
                  q_VE_comp,  # OVE, complications
                  q_VE)       # OVE, no complications

v_qaly_biopsy <- c(q_VE_comp - q_loss_biopsy,  # survive, HVE, complications
                   q_VE      - q_loss_biopsy,  # survive, HVE, no complications
                   q_VE_comp - q_loss_biopsy,  # survive, OVE, complications
                   q_VE      - q_loss_biopsy,  # survive, OVE, no complications
                   q_death_biopsy)             # die from biopsy
  
## Costs
v_cost_notx  <- c(c_VE_comp + c_lifetime_comp,  # HVE, complications
                  c_VE      + c_lifetime,       # HVE, no complications
                  c_VE_comp + c_lifetime_comp,  # OVE, complications
                  c_VE      + c_lifetime)       # OVE, no complications
  
v_cost_tx    <- c(c_VE_comp + c_lifetime_comp + c_tx,  # HVE, complications 
                  c_VE      + c_lifetime      + c_tx,  # HVE, no complications 
                  c_VE_comp + c_lifetime_comp + c_tx,  # OVE, complications 
                  c_VE      + c_lifetime      + c_tx)  # OVE, no complications 
  
v_cost_biopsy  <- c(c_biopsy + c_VE_comp + c_lifetime_comp + c_tx,  # survive, HVE, complications 
                    c_biopsy + c_VE      + c_lifetime      + c_tx,  # survive, HVE, no complications 
                    c_biopsy + c_VE_comp + c_lifetime_comp       ,  # survive, OVE, complications
                    c_biopsy + c_VE      + c_lifetime            ,  # survive, OVE, no complications
                    c_biopsy)                                       # die from biopsy

# Calculate expected value for each outcome and strategy
## Expected QALYs
total_qaly_notx   <- v_prob_notx   %*%  v_qaly_notx      
total_qaly_tx     <- v_prob_tx     %*%  v_qaly_tx
total_qaly_biopsy <- v_prob_biopsy %*%  v_qaly_biopsy
  
## Expected costs
total_cost_notx   <- v_prob_notx   %*%  v_cost_notx    
total_cost_tx     <- v_prob_tx     %*%  v_cost_tx
total_cost_biopsy <- v_prob_biopsy %*%  v_cost_biopsy

## Store expected values in a vector
v_total_qaly <- c(total_qaly_notx, total_qaly_tx, total_qaly_biopsy)  # vector of total QALYs
names(v_total_qaly) <- v_names_str # assign strategy names

v_total_cost <- c(total_cost_notx, total_cost_tx, total_cost_biopsy)  # vector of total costs
names(v_total_cost) <- v_names_str # assign strategy names

## Final model output
df_output <- data.frame(Strategy =  v_names_str,
                        Cost     =  v_total_cost,
                        Effect   =  v_total_qaly)
```

## 05 Cost-Effectiveness Analysis

```{r}
# create the transition probability matrix for NO treatment
decision_tree_HVE_cea  <- calculate_icers(cost       = df_output$Cost,
                                          effect     = df_output$Effect,
                                          strategies = df_output$Strategy)
decision_tree_HVE_cea

```

## 05.1 Plot frontier of Decision Tree

```{r}
plot(decision_tree_HVE_cea, effect_units = "QALYs", label = "all")

```

