---
title: 'Function for decision modelling - Demo'
author: "The DARTH workgroup for EL005"
output:
  html_document: default
  pdf_document: default
keep_tex: yes
self_contained: no
---

Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:
Fernando Alarid-Escudero, PhD  
Eva A. Enns, MS, PhD 
M.G. Myriam Hunink, MD, PhD 
Hawre J. Jalal, MD, PhD 
Eline Krijkamp, PhD 
Petros Pechlivanoglou, PhD
Alan Yang, MSc

Please cite relevant publications when using this code, see suggestions below. 

# Intro to R 
During the intro to R module you have been introduced to the concept of loops and functions. You now know the general syntax for *functions*: `function_name(arguments)`.

```
function_name <- function(arguments) {
   ...
   return(output)
}
```

You have seen some pre-specified (built-in) function in `R`, like  `mean()`, `max()`, `quantile()`). In addition, you have some experience writing your own function. Remember, you wrote a function to converts Fahrenheit to Celsius using the following formula: (F-32) * 5 / 9. 

```{r}
convert_fahrenheit_to_celsius <- function (n_temp_fahrenheit){
  n_temp_celsius <- (n_temp_fahrenheit - 32) * 5 / 9
  n_temp_celsius <- round(n_temp_celsius, 1) # option to round the temperature
  return(n_temp_celsius) 
}

# test the function
convert_fahrenheit_to_celsius (n_temp_fahrenheit = 100)

```


You have also been introduce to the concept, that function can have a large number of `arguments`, or function inputs, separated by commas. The `output` from a function can have multiple elements that should be returned as a list. 

```
function_name <- function(argument1, argument2, argument3) {
   ...
   return(list(output1, output2, output3)
}
```

When we apply this to decision modeling, one could thing about

```{r}
calculate_treatment_costs <- function(trt, disease_history, kg, c_blood_tinners = 5, c_drug_per_mg = 10, currency = "euro"){
# Arguments
   # trt: does the patient get a treatment: yes/ no
   # disease_history: previous history of disease; if there is a previous history of disease, the patients are on permanent treatment of blood_tinner
   # kg: the drug is doses in 2 mg per kilogram
   # c_blood_tinners: cost price of the blood tinners, default is 5 euro
   # c_drug_per_mg: cost price per mg of the drug, default is 10 euro
   # currency: the currency use, default is EURO
  
   # When there is no treatment, the patients that have a history of disease have the cost os blood tinners
   # No treatment, and without history of disease, have no costs 
   c_trt <- 0 + c_blood_tinners * disease_history 
   
   # For those that get the treatment, the cost depents on the dose + disease history
   # captured in the equation below
   if (trt == TRUE){
   dose <- kg / 2
   c_trt <- dose * c_drug_per_mg + c_blood_tinners * disease_history
   }
   
   # we assume a currency convertion of 1.02
   if (currency  == "dollar"){
   c_trt <- c_trt * 1.02
   }
   return(c_trt) # Return the treatment costs 
}

calculate_treatment_costs(trt = TRUE, disease_history = TRUE, kg = 63)
calculate_treatment_costs(trt = TRUE, disease_history = TRUE, kg = 63, currency = "dollar")


```

The return of a function is not only limited to a single value. This can also be a list

```{r}

calculate_treatment_costs <- function(trt, disease_history, kg, c_blood_tinners = 5, c_drug_per_mg = 10, currency = "euro"){
# Arguments
   # trt: does the patient get a treatment: yes/ no
   # disease_history: previous history of disease; if there is a previous history of disease, the patients are on permanent treatment of blood_tinner
   # kg: the drug is doses in 2 mg per kilogram
   # c_blood_tinners: cost price of the blood tinners, default is 5 euro
   # c_drug_per_mg: cost price per mg of the drug, default is 10 euro
   # currency: the currency use, default is EURo
  
   # When there is no treatment, the patients that have a history of disease have the cost os blood tinners
   # No treatment, and without history of disease, have no costs 
   c_trt <- 0 + c_blood_tinners * disease_history 
   
   # For those that get the treatment, the cost depents on the dose + disease history
   # captured in the equation below
   if (trt == TRUE){
   dose <- kg / 2
   c_trt <- dose * c_drug_per_mg + c_blood_tinners * disease_history
   }
   
   
  # ****** NEW***********
   # we assume a currency convertion of 1.02
   if (currency  == "dollar"){
   c_trt <- c_trt * 1.02
   }
   
   l_costs <- list(currency = currency,
                costs = c_trt)
   
   return(l_costs) # Return the treatment costs 
}

calculate_treatment_costs(trt = TRUE, disease_history = TRUE, kg = 63)
calculate_treatment_costs(trt = TRUE, disease_history = TRUE, kg = 63, currency = "dollar")
```

Rather than having multiple arguments in your function, you can also group them in a list. Within the function, you can use the `with` function to access the elements of the list. 
Normally, in a list you would access an element using the `$` sign. However, in a function, you can use the `with` function to access the elements of the list by just using the variable name. 

```{r}

l_params_input <- list(trt = TRUE, 
                       disease_history = TRUE, 
                       kg = 63,
                       c_blood_tinners = 5, 
                       c_drug_per_mg = 10,
                       currency = "dollar")


calculate_treatment_costs <- function(l_params_input){
  with(l_params_input, { 
# Arguments
   # trt: does the patient get a treatment: yes/ no
   # disease_history: previous history of disease; if there is a previous history of disease, the patients are on permanent treatment of blood_tinner
   # kg: the drug is doses in 2 mg per kilogram
   # c_blood_tinners: cost price of the blood tinners, default is 5 euro
   # c_drug_per_mg: cost price per mg of the drug, default is 10 euro
   # currency: the currency use, default is EURO
  
   # When there is no treatment, the patients that have a history of disease have the cost os blood tinners
   # No treatment, and without history of disease, have no costs 
   c_trt <- 0 + c_blood_tinners * disease_history 
   
   # For those that get the treatment, the cost depents on the dose + disease history
   # captured in the equation below
   if (trt == TRUE){
   dose <- kg / 2
   c_trt <- dose * c_drug_per_mg + c_blood_tinners * disease_history
   }
   
   # we assume a currency convertion of 1.02
   if (currency  == "dollar"){
   c_trt <- c_trt * 1.02
   }
   return(c_trt) # Return the treatment costs 
  } ) #close with
  } #close function

calculate_treatment_costs(l_params_input)


```


# Acknowlegdement

For this work we made use of the template developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup: <http://darthworkgroup.com>.

The notation of our code is based on the following provided framework and coding convention: Alarid-Escudero, F., Krijkamp, E., Pechlivanoglou, P. et al. A Need for Change! A Coding Framework for Improving Transparency in Decision Modeling. PharmacoEconomics 37, 1329â€“1339 (2019). <https://doi.org/10.1007/s40273-019-00837-x>.

- Alarid-Escudero F, Krijkamp EM, Enns EA, Yang A, Hunink MGM Pechlivanoglou P,
Jalal H. An Introductory Tutorial on Cohort State-Transition Models in R Using a 
Cost-Effectiveness Analysis Example. Medical Decision Making, 2023; 43(1).
(Epub). <https://doi.org/10.1177/0272989X221103163>

- Alarid-Escudero F, Krijkamp EM, Enns EA, Yang A, Hunink MGM Pechlivanoglou P,
Jalal H. A Tutorial on Time-Dependent Cohort State-Transition Models in R using 
a Cost-Effectiveness Analysis Example. Medical Decision Making, 2023; 43(1). 
<https://doi.org/10.1177/0272989X221121747>


Other work from DARTH can be found on the website: <http://darthworkgroup.com/publications/>

# Copyright for assignment work

Copyright 2017, THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS.All rights reserved in Canada, the United States and worldwide. Copyright, trademarks, trade names and any and all associated intellectual property are exclusively owned by THE HOSPITAL FOR Sick CHILDREN and the collaborating  institutions. These materials may be used, reproduced, modified, distributed and adapted with proper attribution.



