---
title: 'Simple 3-state microsimulation model'
subtitle: 'Includes sex specific probability of dying when healthy and state occupation: probability of dying when sick depends on the time of being sick'
author: "The DARTH workgroup"
output:
  pdf_document: default
  html_document: default
---

<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<p>Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:</p>
<p>Fernando Alarid-Escudero, PhD (1)</p>
<p>Eva A. Enns, MS, PhD (2)</p>
<p>M.G. Myriam Hunink, MD, PhD (3,4)</p>
<p>Hawre J. Jalal, MD, PhD (5)</p>
<p>Eline M. Krijkamp, MSc (3)</p>
<p>Petros Pechlivanoglou, PhD (6,7)</p>
<p>Alan Yang, MSc (7)</p>
<p>In collaboration of:</p>
<ol style="list-style-type: decimal">
<li>Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT,
Aguascalientes, Mexico</li>
<li>University of Minnesota School of Public Health, Minneapolis, MN, USA</li>
<li>Erasmus MC, Rotterdam, The Netherlands</li>
<li>Harvard T.H. Chan School of Public Health, Boston, USA</li>
<li>University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA</li>
<li>University of Toronto, Toronto ON, Canada</li>
<li>The Hospital for Sick Children, Toronto ON, Canada</li>
</ol>
<p>Please cite our publications when using this code:</p>
<ul>
<li><p>Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG.
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P.
Microsimulation modeling for health decision sciences using R: A tutorial.
Med Decis Making. 2018;38(3):400â€“22.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H.
A Multidimensional Array Representation of State-Transition Model Dynamics.
Med Decis Making. 2020 Online first. <a href="https://doi.org/10.1177/0272989X19893973" class="uri">https://doi.org/10.1177/0272989X19893973</a></p></li>
</ul>
<div style="page-break-after: always;"></div>
<p>Change <code>eval</code> to <code>TRUE</code> if you want to knit this document.</p>
<pre class="r"><code>rm(list = ls())      # clear memory (removes all the variables from the workspace)</code></pre>
<div id="load-packages" class="section level1">
<h1>01 Load packages</h1>
<pre class="r"><code>if (!require(&#39;pacman&#39;)) install.packages(&#39;pacman&#39;); library(pacman) 

# load (install if required) packages from CRAN
p_load(&quot;here&quot;, &quot;devtools&quot;, &quot;dplyr&quot;, &quot;scales&quot;, &quot;ellipse&quot;, &quot;ggplot2&quot;, &quot;lazyeval&quot;, &quot;igraph&quot;, &quot;truncnorm&quot;, &quot;ggraph&quot;, &quot;reshape2&quot;, &quot;knitr&quot;, &quot;markdown&quot;, &quot;stringr&quot;)
# load (install if required) packages from GitHub
# install_github(&quot;DARTH-git/dampack&quot;, force = TRUE) # Uncomment if there is a newer version
# install_github(&quot;DARTH-git/darthtools&quot;, force = TRUE) # Uncomment if there is a newer version
p_load_gh(&quot;DARTH-git/dampack&quot;, &quot;DARTH-git/darthtools&quot;)</code></pre>
</div>
<div id="load-functions" class="section level1">
<h1>02 Load functions</h1>
<pre class="r"><code># No functions needed</code></pre>
</div>
<div id="input-model-parameters" class="section level1">
<h1>03 Input model parameters</h1>
<pre class="r"><code>set.seed(1)  # set the seed  

# Model structure
v_n        &lt;- c(&quot;healthy&quot;, &quot;sick&quot;, &quot;dead&quot;)  # vector with state names
n_states   &lt;- length(v_n)                   # number of states
n_t        &lt;- 60                            # number of cycles
n_i        &lt;- 10000                         # number of individuals
d_e &lt;- d_c &lt;- 0.03                          # equal discount of costs and QALYs by 3%

# calculate discount weights for costs for each cycle based on discount rate d_c
v_dwc &lt;- 1 / (1 + d_e) ^ (0:n_t) 
# calculate discount weights for effectiveness for each cycle based on discount rate d_e
v_dwe &lt;- 1 / (1 + d_c) ^ (0:n_t) 

#### Deterministic analysis ####
# Transition probabilities 
# (all non-dead probabilities are conditional on survival)
p_HS        &lt;- 0.05    # probability healthy -&gt; sick
p_HD_female &lt;- 0.0382  # probability health -&gt; dead when female
p_HD_male   &lt;- 0.0463  # probability health -&gt; dead when male
m_p_HD      &lt;- data.frame(Sex = c(&quot;Female&quot;, &quot;Male&quot;), p_HD = c(p_HD_female, p_HD_male))

# probability to die in sick state by cycle of being sick
p_SD &lt;- c(0.1, 0.2, 0.3, 0.4, 0.5, rep(0.7, n_t - 5)) 

# Costs inputs
c_H  &lt;- 1500  # cost of one cycle in healthy state
c_S  &lt;- 5000  # cost of one cycle in sick state
c_D  &lt;- 0

# utility inputs
u_H  &lt;- 1     # utility when healthy 
u_S  &lt;- 0.85  # utility when sick 
u_D  &lt;- 0     # utility when dead </code></pre>
</div>
<div id="sample-individual-level-characteristics" class="section level1">
<h1>04 Sample individual level characteristics</h1>
<div id="static-characteristics" class="section level2">
<h2>04.1 Static characteristics</h2>
<pre class="r"><code># randomly sample the sex of an individual (50% female)
v_sex &lt;- sample(x = c(&quot;Female&quot;, &quot;Male&quot;), prob = c(0.5, 0.5), size = n_i, replace = TRUE) </code></pre>
</div>
<div id="dynamic-characteristics" class="section level2">
<h2>04.2 Dynamic characteristics</h2>
<pre class="r"><code># Specify the initial health state of the individuals 
# everyone begins in the healthy state (in this example)
v_M_init  &lt;- rep(&quot;healthy&quot;, times = n_i)   
v_Ts_init &lt;- rep(0, n_i)  # a vector with the time of being sick at the start of the model </code></pre>
</div>
<div id="create-a-dataframe-with-the-individual-characteristics" class="section level2">
<h2>04.3 Create a dataframe with the individual characteristics</h2>
<pre class="r"><code># create a data frame with each individual&#39;s 
# ID number, treatment effect modifier, age and initial time in sick state 
df_X  &lt;- data.frame(ID = 1:n_i, Sex = v_sex, Ts_init = v_Ts_init, M_init = v_M_init)
head(df_X) # print the first rows of the dataframe</code></pre>
</div>
</div>
<div id="define-simulation-functions" class="section level1">
<h1>05 Define Simulation Functions</h1>
<div id="probability-function" class="section level2">
<h2>05.1 Probability function</h2>
<p>The <code>Probs</code> function updates the transition probabilities of every cycle is shown below.</p>
<pre class="r"><code>Probs &lt;- function(M_t, df_X, v_Ts) { 
  # Arguments:
    # M_t: health state occupied at cycle t (character variable)
    # df_X: data frame with individual characteristics data 
    # v_Ts: vector with the duration of being sick
  # Returns: 
    # transition probabilities for that cycle
  
  # create matrix of state transition probabilities
  m_p_t           &lt;- matrix(0, nrow = n_states, ncol = n_i)  
  # give the state names to the rows
  rownames(m_p_t) &lt;-  v_n                               
  
  # lookup baseline probability and rate of dying based on individual characteristics
  p_HD_all &lt;- inner_join(df_X, m_p_HD, by = c(&quot;Sex&quot;))
  p_HD     &lt;- p_HD_all[M_t == &quot;healthy&quot;, &quot;p_HD&quot;]
  
  # update m_p_t with the appropriate probabilities 
  # (all non-death probabilities are conditional on survival)
  # transition probabilities when healthy 
  m_p_t[, M_t == &quot;healthy&quot;] &lt;- rbind((1 - p_HD) * (1 - p_HS) ,
                                     (1 - p_HD) *      p_HS  ,
                                          p_HD)    
  # transition probabilities when sick 
  m_p_t[, M_t == &quot;sick&quot;]    &lt;- rbind(0,
                                     1 - p_SD[v_Ts],
                                         p_SD[v_Ts])  
  # transition probabilities when dead     
  m_p_t[, M_t == &quot;dead&quot;]    &lt;- rbind(0,
                                     0,
                                     1)                            
  
  return(t(m_p_t))
}       </code></pre>
</div>
<div id="cost-function" class="section level2">
<h2>05.2 Cost function</h2>
<p>The <code>Costs</code> function estimates the costs at every cycle.</p>
<pre class="r"><code>Costs &lt;- function (M_t) {
  # Arguments:
    # M_t: health state occupied at cycle t (character variable)
  # Returns: 
    # costs accrued in this cycle
  
  c_t &lt;- c()
  c_t[M_t == &quot;healthy&quot;] &lt;- c_H  # costs accrued by being healthy this cycle
  c_t[M_t == &quot;sick&quot;]    &lt;- c_S  # costs accrued by being sick this cycle
  c_t[M_t == &quot;dead&quot;]    &lt;- c_D  # costs at dead state
  
  return(c_t) 
}</code></pre>
</div>
<div id="health-outcome-function" class="section level2">
<h2>05.3 Health outcome function</h2>
<p>The <code>Effs</code> function to update the utilities at every cycle.</p>
<pre class="r"><code>Effs &lt;- function (M_t) {
  # Arguments:
    # M_t: health state occupied at cycle t (character variable)
  # Returns: 
    # QALYs accrued this cycle
  
  q_t &lt;- c() 
  q_t[M_t == &quot;healthy&quot;] &lt;- u_H  # QALYs accrued by being healthy this cycle
  q_t[M_t == &quot;sick&quot;]    &lt;- u_S  # QALYs accrued by being sick this cycle
  q_t[M_t == &quot;dead&quot;]    &lt;- u_D  # QALYs at dead state
  
  return(q_t)  
}</code></pre>
</div>
<div id="microsimulation-function" class="section level2">
<h2>05.4 Microsimulation function</h2>
<p>Below we develop the microsimulation function that allows the model to be run.</p>
<pre class="r"><code>MicroSim &lt;- function(n_i, df_X, seed = 1) {
  # Arguments:  
    # n_i: number of individuals
    # df_X: data frame with individual data 
    # seed: seed for the random number generator, default is 1
  # Returns:
    # results: data frame with total cost and QALYs
  
  set.seed(seed) # set a seed to be able to reproduce the same results
  
  # create three matrices called m_M, m_C and m_E
  # number of rows is equal to the n_i, the number of columns is equal to n_t 
  # (the initial state and all the n_t cycles)
  # m_M is used to store the health state information over time for every individual
  # m_C is used to store the costs information over time for every individual
  # m_E is used to store the effects information over time for every individual
  
  m_M &lt;- m_C &lt;- m_E &lt;-  matrix(nrow = n_i, ncol = n_t + 1, 
                               dimnames = list(paste(&quot;ind&quot;  , 1:n_i, sep = &quot; &quot;), 
                                               paste(&quot;cycle&quot;, 0:n_t, sep = &quot; &quot;)))  
 
  m_M[, 1] &lt;- as.character(df_X$M_init) # initial health state
  v_Ts     &lt;- df_X$Ts_init     # initialize time since illness onset
  m_C[, 1] &lt;- Costs(m_M[, 1])  # costs accrued during cycle 0
  m_E[, 1] &lt;- Effs(m_M[, 1])   # QALYs accrued during cycle 0
  
  # open a loop for time running cycles 1 to n_t 
  for (t in 1:n_t) {
    # calculate the transition probabilities for the cycle based on health state t
    m_P &lt;- Probs(m_M[, t], df_X, v_Ts)
    # check if transition probabilities are between 0 and 1
    check_transition_probability(m_P, verbose = TRUE)
    # check if each of the rows of the transition probabilities matrix sum to one
    check_sum_of_transition_array(m_P, n_states = n_i, n_t = n_t, verbose = TRUE)
    # sample the next health state and store that state in matrix m_M
    m_M[, t + 1]  &lt;- samplev(m_P)    
    # calculate costs per individual during cycle t + 1
    m_C[, t + 1]  &lt;- Costs(m_M[, t + 1])  
    # calculate QALYs per individual during cycle t + 1
    m_E[, t + 1]  &lt;- Effs (m_M[, t + 1])  
    
    # update time since illness onset for t + 1 
    v_Ts &lt;- if_else(m_M[, t + 1] == &quot;sick&quot;, v_Ts + 1, 0) 
    
    # Display simulation progress
    if(t/(n_t/10) == round(t/(n_t/10), 0)) { # display progress every 10%
      cat(&#39;\r&#39;, paste(t/n_t * 100, &quot;% done&quot;, sep = &quot; &quot;))
    }
    
  } # close the loop for the time points 
  
  # calculate  
  tc &lt;- m_C %*% v_dwc  # total (discounted) cost per individual
  te &lt;- m_E %*% v_dwe  # total (discounted) QALYs per individual 
  tc_hat &lt;- mean(tc)   # average (discounted) cost 
  te_hat &lt;- mean(te)   # average (discounted) QAL  
  # store the results from the simulation in a list
  results &lt;- list(m_M = m_M, m_C = m_C, m_E = m_E, tc = tc , te = te, tc_hat = tc_hat, 
                  te_hat = te_hat)   
  
  return(results)  # return the results

} # end of the `MicroSim` function  </code></pre>
</div>
<div id="run-microsimulation" class="section level2">
<h2>06 Run Microsimulation</h2>
<pre class="r"><code># 06 Run Microsimulation

# By specifying all the arguments in the `MicroSim()` the simulation can be started

# Run the simulation model
outcomes &lt;- MicroSim(n_i = n_i, df_X = df_X, seed = 1)

# Show results
results  &lt;- data.frame(&quot;Total Cost&quot; = outcomes$tc_hat, &quot;Total QALYs&quot; = outcomes$te_hat)
results</code></pre>
</div>
</div>
<div id="visualize-results" class="section level1">
<h1>07 Visualize results</h1>
<pre class="r"><code>options(scipen = 999)   # disable scientific notation in R
plot(density(outcomes$tc), main = paste(&quot;Total cost per person&quot;), xlab = &quot;Cost ($)&quot;)
plot(density(outcomes$te), main = paste(&quot;Total QALYs per person&quot;), xlab = &quot;QALYs&quot;)
plot_m_TR(outcomes$m_M) # health state trace</code></pre>
</div>
