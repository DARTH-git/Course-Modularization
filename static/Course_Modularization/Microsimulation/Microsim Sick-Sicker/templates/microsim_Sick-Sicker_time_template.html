---
title: 'Microsimulation Sick-Sicker model with time dependency'
subtitle: 'Includes individual characteristics: age, age dependent mortality, individual treatment effect modifier, state-residency for the sick (S1) state, increasing change of death in the first 6 year of sickness'
author: "The DARTH workgroup"
output:
  pdf_document: default
  html_document: default
---

<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<p>Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:</p>
<p>Fernando Alarid-Escudero, PhD (1)</p>
<p>Eva A. Enns, MS, PhD (2)</p>
<p>M.G. Myriam Hunink, MD, PhD (3,4)</p>
<p>Hawre J. Jalal, MD, PhD (5)</p>
<p>Eline M. Krijkamp, MSc (3)</p>
<p>Petros Pechlivanoglou, PhD (6)</p>
<p>Alan Yang, MSc (7)</p>
<p>In collaboration of:</p>
<ol style="list-style-type: decimal">
<li>Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT,
Aguascalientes, Mexico</li>
<li>University of Minnesota School of Public Health, Minneapolis, MN, USA</li>
<li>Erasmus MC, Rotterdam, The Netherlands</li>
<li>Harvard T.H. Chan School of Public Health, Boston, USA</li>
<li>University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA</li>
<li>University of Toronto, Toronto ON, Canada</li>
<li>The Hospital for Sick Children, Toronto ON, Canada</li>
</ol>
<p>Please cite our publications when using this code:</p>
<ul>
<li><p>Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG.
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P.
Microsimulation modeling for health decision sciences using R: A tutorial.
Med Decis Making. 2018;38(3):400–22.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H.
A Multidimensional Array Representation of State-Transition Model Dynamics.
Med Decis Making. 2020 Online first. <a href="https://doi.org/10.1177/0272989X19893973" class="uri">https://doi.org/10.1177/0272989X19893973</a></p></li>
</ul>
<div style="page-break-after: always;"></div>
<p>Change <code>eval</code> to <code>TRUE</code> if you want to knit this document.</p>
<pre class="r"><code>rm(list = ls())      # clear memory (removes all the variables from the workspace)</code></pre>
<div id="load-packages" class="section level1">
<h1>01 Load packages</h1>
<pre class="r"><code>if (!require(&#39;pacman&#39;)) install.packages(&#39;pacman&#39;); library(pacman) 
# load (install if required) packages from CRAN
p_load(&quot;here&quot;, &quot;devtools&quot;, &quot;dplyr&quot;, &quot;scales&quot;, &quot;ellipse&quot;, &quot;ggplot2&quot;, &quot;lazyeval&quot;, &quot;igraph&quot;, &quot;truncnorm&quot;, &quot;ggraph&quot;, &quot;reshape2&quot;, &quot;knitr&quot;, &quot;markdown&quot;, &quot;stringr&quot;)
# load (install if required) packages from GitHub
# install_github(&quot;DARTH-git/dampack&quot;, force = TRUE) # Uncomment if there is a newer version
# install_github(&quot;DARTH-git/darthtools&quot;, force = TRUE) # Uncomment if there is a newer version
p_load_gh(&quot;DARTH-git/dampack&quot;, &quot;DARTH-git/darthtools&quot;)</code></pre>
</div>
<div id="load-functions" class="section level1">
<h1>02 Load functions</h1>
<pre class="r"><code># No functions needed</code></pre>
</div>
<div id="input-model-parameters" class="section level1">
<h1>03 Input model parameters</h1>
<pre class="r"><code>set.seed(1)  # set the seed  

# Model structure 
n_t   &lt;- 30                       # time horizon, 30 cycles
n_i   &lt;- 100000                   # number of simulated individuals
v_n   &lt;- c(&quot;H&quot;, &quot;S1&quot;, &quot;S2&quot;, &quot;D&quot;)  # the model states names
n_states &lt;- length(v_n)           # the number of health states
d_r   &lt;- 0.03                     # discount rate of 3% per cycle
v_dwe &lt;- v_dwc &lt;- 1 / ((1 + d_r) ^ (0:n_t))    # discount weight 
v_names_str &lt;- c(&quot;no treatment&quot;, &quot;treatment&quot;)  # strategy names
n_str &lt;- length(v_names_str)      # number of strategies

# Event probabilities (per cycle)
# Annual transition probabilities
# (all non-probabilities are conditional on survival)
p_HS1   &lt;- 0.15   # probability of becoming sick when healthy
p_S1H   &lt;- 0.5    # probability of recovering to healthy when sick
p_S1S2  &lt;- 0.105  # probability of becoming sicker when sick

# Annual probabilities of death
# load age dependent probability
p_mort   &lt;- read.csv(&quot;mortProb_age.csv&quot;)
# load age distribution
dist_Age &lt;- read.csv(&quot;MyPopulation-AgeDistribution.csv&quot;) 

# probability to die in S1 by cycle (is increasing)
p_S1D    &lt;- c(0.0149, 0.018, 0.021, 0.026, 0.031, rep(0.037, n_t - 5)) 
p_S2D    &lt;- 0.048  # probability to die in S2

# Cost inputs
c_H     &lt;- 2000    # cost of one cycle in the healthy state
c_S1    &lt;- 4000    # cost of one cycle in the sick state  
c_S2    &lt;- 15000   # cost of one cycle in the sicker state
c_D     &lt;- 0       # cost of one cycle in the dead state
c_trt   &lt;- 12000   # cost of treatment (per cycle)

# Utility inputs
u_H     &lt;- 1       # utility when healthy 
u_S1    &lt;- 0.75    # utility when sick 
u_S2    &lt;- 0.5     # utility when sicker
u_D     &lt;- 0       # utility when dead
u_trt   &lt;- 0.95    # utility when sick and being treated</code></pre>
</div>
<div id="sample-individual-level-characteristics" class="section level1">
<h1>04 Sample individual level characteristics</h1>
<div id="static-characteristics" class="section level2">
<h2>04.1 Static characteristics</h2>
<pre class="r"><code>v_x     &lt;- runif(n_i, min = 0.95, max = 1.05) # treatment effect modifier at baseline 
# your turn</code></pre>
</div>
<div id="dynamic-characteristics" class="section level2">
<h2>04.2 Dynamic characteristics</h2>
<pre class="r"><code># your turn</code></pre>
</div>
<div id="create-a-dataframe-with-the-individual-characteristics" class="section level2">
<h2>04.3 Create a dataframe with the individual characteristics</h2>
<pre class="r"><code># your turn
# HINT: df_X &lt;- # data.frame(# ADD ALL CHARACTERISTICS) </code></pre>
</div>
</div>
<div id="define-simulation-functions" class="section level1">
<h1>05 Define Simulation Functions</h1>
<p><em>HINT</em>: There is no need to make two functions for each strategy. We recommend to make one <code>Probs()</code>, one <code>Costs()</code> and one <code>Effs()</code> function and have a function argument <code>Trt</code> which you “switch” on and off (i.e TRUE/FALSE - or 0/1) of the strategy of interest.</p>
<div id="probability-function" class="section level2">
<h2>05.1 Probability function</h2>
<p>The function that updates the transition probabilities of every cycle is shown below.</p>
<p>Please make sure you incorporate the time dependency</p>
<pre class="r"><code># your turn
# HINT: In this function you have to incorporate age specific mortality and incorporate 
# the change in probability of the years spend in the sick state</code></pre>
</div>
<div id="cost-function" class="section level2">
<h2>05.2 Cost function</h2>
<p>The <code>Costs</code> function estimates the costs at every cycle.</p>
<pre class="r"><code># your turn
# Make sure you incorporate the cost of the treatment in the treatment strategy for both sick and sicker</code></pre>
</div>
<div id="health-outcome-function" class="section level2">
<h2>05.3 Health outcome function</h2>
<p>The <code>Effs</code> function to update the utilities at every cycle.</p>
<pre class="r"><code># your turn
# HINT: Make sure you incorporate the treatment effect modifier 
# HINT: Remember treatment improves the quality of life for those in the Sick (S1) state but not for those in the Sicker (S2) state</code></pre>
</div>
<div id="the-microsimulation-function" class="section level2">
<h2>05.4 The Microsimulation function</h2>
<p>You need to develop the main function <code>MicroSim()</code> that runs the microsimulation.</p>
<pre class="r"><code># your turn
# HINT: Build your own `MicroSim` function here that calls the Effs() and Costs() functions and samples the new state for the n_i individuals </code></pre>
</div>
</div>
<div id="run-microsimulation" class="section level1">
<h1>06 Run Microsimulation</h1>
<p>You have to run the <code>Microsim()</code> function twice. Once for the treatment strategy and once of the no-treatment strategy, as follows:</p>
<ul>
<li><p><code>outcomes_no_trt  &lt;- MicroSim(n_i, df_X, Trt = FALSE, seed = 1)</code></p></li>
<li><p><code>outcomes_trt     &lt;- MicroSim(n_i, df_X, Trt = TRUE,  seed = 1)</code></p></li>
</ul>
</div>
<div id="visualize-results" class="section level1">
<h1>07 Visualize results</h1>
<pre class="r"><code># your turn
# HINT: use pre-defined functions in &quot;Functions.R&quot; or check the example code</code></pre>
</div>
<div id="cost-effectiveness-analysis" class="section level1">
<h1>08 Cost Effectiveness Analysis</h1>
<pre class="r"><code># store the mean costs of each strategy in a new variable v_C (vector of costs)
# remove # below
# v_C &lt;- c(outcomes_no_trt$tc_hat, outcomes_trt$tc_hat)

# store the mean QALYs of each strategy in a new variable v_E (vector of effects)
# remove # below
# v_E &lt;- c(outcomes_no_trt$te_hat, outcomes_trt$te_hat)


# remove # below
# use dampack to calculate the ICER
# calculate_icers(cost       = v_C,
#                 effect     = v_E,
#                 strategies = v_names_str)</code></pre>
</div>
