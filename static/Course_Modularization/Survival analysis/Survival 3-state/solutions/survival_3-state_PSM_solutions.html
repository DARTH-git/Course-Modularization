---
title: 'Simple 3-state Partitioned Survival model in R'
author: "The DARTH workgroup"
output:
  pdf_document: default
  html_document: default
---

<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<p>Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:</p>
<p>Fernando Alarid-Escudero, PhD (1)</p>
<p>Eva A. Enns, MS, PhD (2)</p>
<p>M.G. Myriam Hunink, MD, PhD (3,4)</p>
<p>Hawre J. Jalal, MD, PhD (5)</p>
<p>Eline M. Krijkamp, MSc (3)</p>
<p>Petros Pechlivanoglou, PhD (6)</p>
<p>Alan Yang, MSc (7)</p>
<p>In collaboration of:</p>
<ol style="list-style-type: decimal">
<li>Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT,
Aguascalientes, Mexico</li>
<li>University of Minnesota School of Public Health, Minneapolis, MN, USA</li>
<li>Erasmus MC, Rotterdam, The Netherlands</li>
<li>Harvard T.H. Chan School of Public Health, Boston, USA</li>
<li>University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA</li>
<li>The Hospital for Sick Children, Toronto and University of Toronto, Toronto ON, Canada</li>
<li>The Hospital for Sick Children, Toronto ON, Canada</li>
</ol>
<p>Please cite our publications when using this code:</p>
<ul>
<li><p>Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG.
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P.
Microsimulation modeling for health decision sciences using R: A tutorial.
Med Decis Making. 2018;38(3):400â€“22.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H.
A Multidimensional Array Representation of State-Transition Model Dynamics.
BioRxiv 670612 2019.https://www.biorxiv.org/content/10.1101/670612v1</p></li>
</ul>
<p>Copyright 2017, THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS.
All rights reserved in Canada, the United States and worldwide. Copyright,
trademarks, trade names and any and all associated intellectual property are
exclusively owned by THE HOSPITAL FOR Sick CHILDREN and the collaborating
institutions. These materials may be used, reproduced, modified, distributed
and adapted with proper attribution.</p>
<div style="page-break-after: always;"></div>
<p>Change <code>eval</code> to <code>TRUE</code> if you want to knit this document.</p>
<div id="load-packages" class="section level1">
<h1>01 Load packages</h1>
<pre class="r"><code>if (!require(&#39;pacman&#39;)) install.packages(&#39;pacman&#39;); library(pacman) # use this package to conveniently install other packages
# load (install if required) packages from CRAN
p_load(&quot;here&quot;, &quot;dplyr&quot;, &quot;devtools&quot;, &quot;gems&quot;, &quot;flexsurv&quot;, &quot;survminer&quot;, &quot;survHE&quot;, &quot;ggplot2&quot;, &quot;msm&quot;, &quot;igraph&quot;, &quot;mstate&quot;, &quot;reshape2&quot;, &quot;knitr&quot;, &quot;diagram&quot;, &quot;abind&quot;)   
# install_github(&quot;DARTH-git/dampack&quot;, force = TRUE) # Uncomment if there is a newer version
# install_github(&quot;DARTH-git/darthtools&quot;, force = TRUE) # Uncomment if there is a newer version
p_load_gh(&quot;DARTH-git/dampack&quot;, &quot;DARTH-git/darthtools&quot;)</code></pre>
</div>
<div id="load-functions" class="section level1">
<h1>02 Load functions</h1>
<pre class="r"><code># No function needed</code></pre>
</div>
<div id="input-model-parameters" class="section level1">
<h1>03 Input model parameters</h1>
<pre class="r"><code>v_names_states &lt;- c(&quot;Healthy&quot;, &quot;Sick&quot;, &quot;Dead&quot;)  # state names

c_l       &lt;- 1 / 12                  # cycle length (a month)
n_t       &lt;- 30                      # number of years (30 years)
set.seed(2020)                       # set the seed
n_sim     &lt;- 100                     # number of simulations

n_states  &lt;- length(v_names_states)  # No of states 
times     &lt;- seq(0, n_t, c_l)        # the cycles in years</code></pre>
<p>Create a transition probability matrix with all transitions indicated and numbered.</p>
<pre class="r"><code>tmat &lt;- matrix(NA, n_states, n_states, dimnames = list(v_names_states, v_names_states))
tmat[&quot;Healthy&quot;, &quot;Sick&quot;]  &lt;- 1
tmat[&quot;Healthy&quot;, &quot;Dead&quot;]  &lt;- 2
tmat[&quot;Sick&quot;   , &quot;Dead&quot;]  &lt;- 3

layout.fig &lt;- c(2,1)
plotmat(t(tmat), t(layout.fig), self.cex = 0.5, curve = 0, arr.pos = 0.76,  
        latex = T, arr.type = &quot;curved&quot;, relsize = 0.85, box.prop=0.8, 
        cex = 0.1, box.cex = 0.7, lwd = 1)</code></pre>
<p>Generate data.</p>
<pre class="r"><code>n_pat       &lt;- 550                       # cohort size
n_years     &lt;- 30                        # number of years 
generate    &lt;- gen_data(n_pat, n_years)  # generates true, censored and OS/PFS data 
OS_PFS_data &lt;- generate$OS_PFS_data      # store the OS / PFS structured data
head(OS_PFS_data)</code></pre>
</div>
<div id="analysis" class="section level1">
<h1>04 Analysis</h1>
<p>Showcasing the use of packages <code>survival</code>, <code>flexsurv</code>.</p>
<pre class="r"><code>fit_KM_OS   &lt;- survfit(Surv(time = OS_time, event = OS_status) ~ 1, data = OS_PFS_data)
plot(fit_KM_OS, mark.time = T)

# a prettier way of plotting!!
ggsurvplot(
  fit_KM_OS, 
  data = OS_PFS_data, 
  size = 1,                  # change line size
  palette = c(&quot;blue3&quot;),      # custom color palettes
  conf.int = TRUE,           # Add confidence interval
  pval = TRUE,               # Add p-value
  risk.table = TRUE,         # Add risk table
  risk.table.height = 0.25,  # Useful to change when you have multiple groups
  ggtheme = theme_bw(),      # Change ggplot2 theme
  xlab = &#39;Time in years&#39;,    # Change X-axis label
  title    = &quot;Survival curve for Overall Survival (OS)&quot;, 
  subtitle = &quot;Based on Kaplan-Meier estimates&quot;
) </code></pre>
<div id="survival-analysis" class="section level2">
<h2>04.1 Survival Analysis</h2>
<p>Fit different parametric survival models and choose the best fitting ones.</p>
<pre class="r"><code># R package flexsurv allows parametric fitting of curves
fit_weib &lt;- flexsurvreg(Surv(time = OS_time, event = OS_status) ~ 1, data = OS_PFS_data,
                        dist = &quot;weibull&quot;)
plot(fit_weib)

# fit all parametric models to the data and extract the AIC/BIC. 
# Select the one with the most appropriate fit
# Repeat for PFS and OS
fit_PFS &lt;- fit.fun(time = &quot;PFS_time&quot;, status = &quot;PFS_status&quot;, data = OS_PFS_data, 
                   extrapolate = TRUE, times = times)
fit_OS  &lt;- fit.fun(time = &quot;OS_time&quot;, status  = &quot;OS_status&quot; , data = OS_PFS_data, 
                   extrapolate = TRUE, times = times) 

# Check AIC of each model to assess goodness-of-fit
GoF_PFS &lt;- data.frame(AIC = fit_PFS$AIC, BIC = fit_PFS$BIC)
GoF_OS  &lt;- data.frame(AIC = fit_OS$AIC,  BIC = fit_OS$BIC)

# &quot;Exponential&quot;, &quot;Weibull (AFT)&quot;, &quot;Gamma&quot;, &quot;log-Normal&quot;, &quot;log-Logistic&quot;, &quot;Gen. Gamma&quot;  
choose_PFS &lt;- rownames(GoF_PFS)[which.min(GoF_PFS$AIC)]
choose_OS  &lt;- rownames(GoF_OS)[which.min(GoF_OS$AIC)]</code></pre>
<p>Superimpose the best-fitting survival curves on the Kaplan-Meier curves.</p>
<pre class="r"><code># PFS
fit_KM_PFS   &lt;- survfit(Surv(time = PFS_time, event = PFS_status) ~ 1, data = OS_PFS_data)
# Select the best fitted survivor function based on the smallest AIC
best_PFS &lt;- fit_PFS$model.objects$models[[choose_PFS]]  
# plot KM for PFS
PFS_superimpose &lt;- ggsurvplot(
  fit_KM_PFS, 
  data = OS_PFS_data, 
  size = 1,                  # change line size
  palette = c(&quot;orange2&quot;),    #  custom color palettes
  conf.int = TRUE,           # Add confidence interval
  pval = TRUE,               # Add p-value
  risk.table = TRUE,         # Add risk table
  risk.table.height = 0.25,  # Useful to change when you have multiple groups
  ggtheme = theme_bw(),      # Change ggplot2 theme
  xlab = &#39;Time in years&#39;,    # Change X-axis label
  title    = &quot;Kaplan-Meier survival curve for Progression-Free Survival (PFS)&quot;, 
  subtitle = paste0(&quot;Superimposed by &quot;, choose_PFS, &quot; survival curve&quot;)
) 
# extract the estimated survival probabilities and the confidence intervals
summary_best_PFS &lt;- as.data.frame(summary(best_PFS)) 
# superimpose the survival probabilities
PFS_superimpose$plot  &lt;- PFS_superimpose$plot + 
  geom_line(aes(x=time, y=est), size=0.55, alpha=0.65, data=summary_best_PFS)
# superimpose the lower bound of the confidence interval
PFS_superimpose$plot  &lt;- PFS_superimpose$plot + 
  geom_line(aes(x=time, y=lcl), size=0.55, alpha=0.65, linetype=&#39;dashed&#39;, data=summary_best_PFS)
# superimpose the upper bound of the confidence interval
PFS_superimpose$plot  &lt;- PFS_superimpose$plot +
  geom_line(aes(x=time, y=ucl), size=0.55, alpha=0.65, linetype=&#39;dashed&#39;, data=summary_best_PFS)
PFS_superimpose

# OS
# Select the best fitted survivor function based on the smallest AIC
best_OS &lt;- fit_OS$model.objects$models[[choose_OS]]  
# plot KM for OS
OS_superimpose &lt;- ggsurvplot(
  fit_KM_OS, 
  data = OS_PFS_data, 
  size = 1,                  # change line size
  palette = c(&quot;blue3&quot;),      #  custom color palettes
  conf.int = TRUE,           # Add confidence interval
  pval = TRUE,               # Add p-value
  risk.table = TRUE,         # Add risk table
  risk.table.height = 0.25,  # Useful to change when you have multiple groups
  ggtheme = theme_bw(),      # Change ggplot2 theme
  xlab = &#39;Time in years&#39;,    # Change X-axis label
  title    = &quot;Kaplan-Meier survival curve for Overall Survival (OS)&quot;, 
  subtitle = paste0(&quot;Superimposed by &quot;, choose_OS, &quot; survival curve&quot;)
) 
# extract the estimated survival probabilities and the confidence intervals
summary_best_OS &lt;- as.data.frame(summary(best_OS)) 
# superimpose the survival probabilities
OS_superimpose$plot  &lt;- OS_superimpose$plot + 
  geom_line(aes(x=time, y=est), size=0.55, alpha=0.65, data=summary_best_OS)
# superimpose the lower bound of the confidence interval
OS_superimpose$plot  &lt;- OS_superimpose$plot + 
  geom_line(aes(x=time, y=lcl), size=0.55, alpha=0.65, linetype=&#39;dashed&#39;, data=summary_best_OS)
# superimpose the upper bound of the confidence interval
OS_superimpose$plot  &lt;- OS_superimpose$plot +
  geom_line(aes(x=time, y=ucl), size=0.55, alpha=0.65, linetype=&#39;dashed&#39;, data=summary_best_OS)
OS_superimpose</code></pre>
</div>
<div id="partitioned-survival-model" class="section level2">
<h2>04.2 Partitioned Survival model</h2>
<pre class="r"><code># construct a partitioned survival model out of the chosen models
m_M_PSM &lt;- partsurv(pfs_survHE = fit_PFS,
                    os_survHE  = fit_OS,
                    choose_PFS = choose_PFS, 
                    choose_OS  = choose_OS,
                    time = times, 
                    v_names_states = v_names_states)

# plot the results of PSM and the true data 
plot_trace_PSM(time = times, partsurv.model = m_M_PSM, v_names_states = v_names_states)
 
# construct a PSA  partitioned survival model out of the fitted models
m_M_PSM_PSA &lt;- partsurv(pfs_survHE = fit_PFS,
                        os_survHE  = fit_OS,
                        choose_PFS = choose_PFS, 
                        choose_OS  = choose_OS,
                        time = times, 
                        v_names_states = v_names_states,
                        PA = T, n_sim = 1000)

# plot the results of PSM and the trace
plot_trace_PSM(time = times, partsurv.model = m_M_PSM_PSA, PA = T, v_names_states = v_names_states)</code></pre>
<p>Other outputs from the partitioned survival model could be explored:</p>
<pre class="r"><code># Expected survival
m_M_PSM$pfs.expected.surv
m_M_PSM$os.expected.surv</code></pre>
</div>
</div>
