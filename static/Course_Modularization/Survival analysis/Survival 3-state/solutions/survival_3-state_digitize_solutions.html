---
title: ' Simple 3-state Digitized Partitioned Survival model in R'
author: "The DARTH workgroup"
output:
  pdf_document: default
  html_document: default
---

<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<p>Developed by the Decision Analysis in R for Technologies in Health (DARTH) workgroup:</p>
<p>Fernando Alarid-Escudero, PhD (1)</p>
<p>Eva A. Enns, MS, PhD (2)</p>
<p>M.G. Myriam Hunink, MD, PhD (3,4)</p>
<p>Hawre J. Jalal, MD, PhD (5)</p>
<p>Eline M. Krijkamp, MSc (3)</p>
<p>Petros Pechlivanoglou, PhD (6)</p>
<p>Alan Yang, MSc (7)</p>
<p>In collaboration of:</p>
<ol style="list-style-type: decimal">
<li>Drug Policy Program, Center for Research and Teaching in Economics (CIDE) - CONACyT,
Aguascalientes, Mexico</li>
<li>University of Minnesota School of Public Health, Minneapolis, MN, USA</li>
<li>Erasmus MC, Rotterdam, The Netherlands</li>
<li>Harvard T.H. Chan School of Public Health, Boston, USA</li>
<li>University of Pittsburgh Graduate School of Public Health, Pittsburgh, PA, USA</li>
<li>The Hospital for Sick Children, Toronto and University of Toronto, Toronto ON, Canada</li>
<li>The Hospital for Sick Children, Toronto ON, Canada</li>
</ol>
<p>Please cite our publications when using this code:</p>
<ul>
<li><p>Jalal H, Pechlivanoglou P, Krijkamp E, Alarid-Escudero F, Enns E, Hunink MG.
An Overview of R in Health Decision Sciences. Med Decis Making. 2017; 37(3): 735-746.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X16686559</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns EA, Jalal HJ, Hunink MGM, Pechlivanoglou P.
Microsimulation modeling for health decision sciences using R: A tutorial.
Med Decis Making. 2018;38(3):400â€“22.
<a href="https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513" class="uri">https://journals.sagepub.com/doi/abs/10.1177/0272989X18754513</a></p></li>
<li><p>Krijkamp EM, Alarid-Escudero F, Enns E, Pechlivanoglou P, Hunink MM, Jalal H.
A Multidimensional Array Representation of State-Transition Model Dynamics.
BioRxiv 670612 2019.https://www.biorxiv.org/content/10.1101/670612v1</p></li>
</ul>
<p>Copyright 2017, THE HOSPITAL FOR SICK CHILDREN AND THE COLLABORATING INSTITUTIONS.
All rights reserved in Canada, the United States and worldwide. Copyright,
trademarks, trade names and any and all associated intellectual property are
exclusively owned by THE HOSPITAL FOR Sick CHILDREN and the collaborating
institutions. These materials may be used, reproduced, modified, distributed
and adapted with proper attribution.</p>
<div style="page-break-after: always;"></div>
<p>Change <code>eval</code> to <code>TRUE</code> if you want to knit this document.</p>
<pre class="r"><code>rm(list = ls())      # clear memory (removes all the variables from the workspace)</code></pre>
<div id="load-packages" class="section level1">
<h1>01 Load packages</h1>
<pre class="r"><code>if (!require(&#39;pacman&#39;)) install.packages(&#39;pacman&#39;); library(pacman) # use this package to conveniently install other packages
# load (install if required) packages from CRAN
p_load(&quot;here&quot;, &quot;dplyr&quot;, &quot;devtools&quot;, &quot;gems&quot;, &quot;flexsurv&quot;, &quot;survHE&quot;, &quot;ggplot2&quot;, &quot;msm&quot;, &quot;igraph&quot;, &quot;mstate&quot;,
        &quot;reshape2&quot;, &quot;knitr&quot;)   </code></pre>
</div>
<div id="load-functions" class="section level1">
<h1>02 Load functions</h1>
<pre class="r"><code>source(&quot;functions.R&quot;)</code></pre>
</div>
<div id="input-model-parameters" class="section level1">
<h1>03 Input model parameters</h1>
<pre class="r"><code>v_n       &lt;- c(&quot;healthy&quot;, &quot;sick&quot;, &quot;dead&quot;)  # state names
n_s       &lt;- length(v_n)                   # No of states 
c_l       &lt;- 1 / 12                        # cycle length (a month)
n_t       &lt;- 20                            # number of years (20 years)
times     &lt;- seq(0, n_t, c_l)              # the cycles in years
d_r       &lt;- 0.03                          # discount rate
set.seed(2009)                             # set the seed

c_H       &lt;- 200                           # cost of remaining one cycle healthy
c_S       &lt;- 500                           # cost of remaining one cycle sick
c_D       &lt;- 0                             # cost of remaining one cycle dead
v_c       &lt;- c(c_H, c_S, c_D)              # store in a vector

u_H       &lt;- 0.75                          # utility when healthy 
u_S       &lt;- 0.30                          # utility when sick
u_D       &lt;- 0                             # utility when dead
v_u       &lt;- c(u_H, u_S, u_D)              # store in a vector

v_dw      &lt;- 1 / (1 + d_r) ^ (times)       # discount weight </code></pre>
</div>
<div id="digitized-data" class="section level1">
<h1>04 Digitized Data</h1>
<p>Use the function <code>digitise()</code> to translate the digitised OS and PFS data into patient level information.</p>
<pre class="r"><code># Create IPD and KM data for the OS curves
digitise(&quot;OS_Examp.txt&quot;, 
         &quot;OS_Examp_AtRisk.txt&quot;, 
         km_output  = &quot;KMdata_OS.txt&quot;, 
         ipd_output = &quot;IPDdata_OS.txt&quot;)

# Create IPD and KM data for the PFS curves (there have been 99 events in the cohort)
digitise(&quot;PFS_Examp.txt&quot;, 
         &quot;PFS_Examp_AtRisk.txt&quot;, 
         km_output  = &quot;KMdata_PFS.txt&quot;, 
         ipd_output = &quot;IPDdata_PFS.txt&quot;)

# Link the IPD files across the two arms of the trial for OS and PFS
IPD_OS  &lt;- make.ipd(ipd_files = c(&quot;IPDdata_OS.txt&quot;), ctr = 1, 
                    var.labs  = c(&quot;time&quot;,&quot;event&quot;,&quot;arm&quot;))
IPD_PFS &lt;- make.ipd(ipd_files = c(&quot;IPDdata_PFS.txt&quot;), ctr = 1,
                    var.labs  = c(&quot;time&quot;,&quot;event&quot;,&quot;arm&quot;))</code></pre>
</div>
<div id="analysis" class="section level1">
<h1>05 Analysis</h1>
<div id="partitioned-survival-model" class="section level2">
<h2>05.1 Partitioned Survival model</h2>
<pre class="r"><code># fit all parametric models to the data and extract the AIC/BIC 
# Select the one with the most appropriate fit
# Repeat for PFS and OS
fit_PFS  &lt;- fit.fun(time =&quot;time&quot;, status = &quot;event&quot;, data = IPD_PFS, times = times,
                    extrapolate = T) 
fit_OS   &lt;- fit.fun(time = &quot;time&quot;, status = &quot;event&quot; , data = IPD_OS, times = times,
                    extrapolate = T) 

best_PFS &lt;- fit_PFS[[&quot;Weibull&quot;]]  
best_OS  &lt;- fit_OS [[&quot;Weibull&quot;]]

# construct a partitioned survival model out of the fitted models
m_M_PSM &lt;- partsurv(best_PFS,best_OS, time = times)$trace
matplot(m_M_PSM, type=&quot;l&quot;)
legend(&quot;right&quot;,v_n, col= 1:3, lty=1:3, bty=&quot;n&quot;)</code></pre>
<p>Calculate total cost and QALYs per cycle.</p>
<pre class="r"><code>v_c_t &lt;- m_M_PSM   %*% v_c
v_u_t &lt;- m_M_PSM   %*% v_u

tot_c &lt;-  t(v_c_t) %*% v_dw
tot_u &lt;-  t(v_u_t) %*% v_dw

# display results
results &lt;- data.frame(Total_Cost = tot_c, Total_QALYs = tot_u)
results</code></pre>
</div>
</div>
